# MCP Agent Chat API

Technick√° dokumentace pro FastAPI backend syst√©m MCP Agenta.

## üèóÔ∏è P≈ôehled architektury

Toto API poskytuje konverzaƒçn√≠ rozhran√≠ pro MCP (Model Context Protocol) agenta, kter√Ω m≈Ø≈æe interagovat s extern√≠mi n√°stroji (jako je Notion). Syst√©m je postaven na architektu≈ôe zalo≈æen√© na session, kter√° udr≈æuje historii konverzace nap≈ô√≠ƒç v√≠ce po≈æadavky.

### Kl√≠ƒçov√© komponenty

1. **FastAPI Server** ([`src/api.py`](../src/api.py)) - HTTP/WebSocket endpointy
2. **Agent Core** ([`src/lib/agent_core.py`](../src/lib/agent_core.py)) - Logika agenta a spr√°va session
3. **MCP Integration** - Orchestrace n√°stroj≈Ø prost≈ôednictv√≠m Model Context Protocol
4. **LangChain** - Abstrakce LLM a pamƒõ≈• konverzace

### Tok po≈æadavku/odpovƒõdi

```
Client Request
    ‚Üì
FastAPI Endpoint (REST/WebSocket/SSE)
    ‚Üì
AgentService.run_query()
    ‚Üì
Session Management (retrieve/create session)
    ‚Üì
MCPAgent.run() - LLM + MCP Tools
    ‚Üì
Update Session History & Memory
    ‚Üì
Response to Client
```

## üß† Design agentn√≠ho syst√©mu

### Architektura zalo≈æen√° na sessions

**Proƒç architektura zalo≈æen√° na sessions?**
- **Zachov√°n√≠ kontextu**: Ka≈æd√Ω u≈æivatel udr≈æuje vlastn√≠ historii konverzace
- **Podpora v√≠ce u≈æivatel≈Ø**: R≈Øzn√≠ u≈æivatel√© mohou v√©st nez√°visl√© konverzace
- **Stavov√© interakce**: Agent si pamatuje p≈ôedchoz√≠ v√Ωmƒõny v r√°mci session

Syst√©m pou≈æ√≠v√° slovn√≠k sessions (`sessions: Dict[str, Dict[str, Any]]`), kter√Ω ukl√°d√°:
- `memory`: instanci [`ConversationBufferMemory`](../src/lib/agent_core.py:67) pro integraci s LangChain
- `history`: Seznam objekt≈Ø zpr√°v pro API odpovƒõdi

**Pozn√°mka pro produkci**: √ölo≈æi≈°tƒõ session v pamƒõti by mƒõlo b√Ωt v produkƒçn√≠m prost≈ôed√≠ nahrazeno Redis nebo datab√°z√≠ pro podporu horizont√°ln√≠ho ≈°k√°lov√°n√≠ a persistence.

### Pamƒõ≈• konverzace

**Proƒç ConversationBufferMemory?**

Syst√©m pou≈æ√≠v√° [`ConversationBufferMemory`](../src/lib/agent_core.py:67) z LangChain s `return_messages=True`:

- **Jednoduch√© a efektivn√≠**: Ukl√°d√° kompletn√≠ historii konverzace bez sumarizace
- **Pln√Ω kontext**: LLM m√° p≈ô√≠stup k cel√© konverzaci pro lep≈°√≠ porozumƒõn√≠
- **Snadn√° integrace**: Bezprobl√©movƒõ funguje s agentn√≠m syst√©mem LangChain
- **Flexibiln√≠**: Snadn√© roz≈°√≠≈ôen√≠ o jin√© typy pamƒõti (summary, window, atd.)

**Kompromisy**:
- ‚úÖ Perfektn√≠ zapamatov√°n√≠ kontextu konverzace
- ‚úÖ ≈Ω√°dn√° ztr√°ta informac√≠ ze sumarizace
- ‚ùå Spot≈ôeba token≈Ø roste s d√©lkou konverzace
- ‚ùå M≈Ø≈æe dos√°hnout limit≈Ø kontextu u velmi dlouh√Ωch konverzac√≠

Pro produkci zva≈æte [`ConversationBufferWindowMemory`](https://python.langchain.com/docs/modules/memory/types/buffer_window) pro efektivnƒõj≈°√≠ vyu≈æit√≠ token≈Ø nebo [`ConversationSummaryMemory`](https://python.langchain.com/docs/modules/memory/types/summary) pro velmi dlouh√© konverzace.

### ≈Ωivotn√≠ cyklus agenta

**Proƒç vytv√°≈ôet nov√©ho agenta pro ka≈æd√Ω po≈æadavek?**

V [`AgentService.run_query()`](../src/lib/agent_core.py:81) je pro ka≈æd√Ω dotaz vytvo≈ôena nov√° instance [`MCPAgent`](../src/lib/agent_core.py:81):

```python
agent = MCPAgent(llm=self.llm, client=self.client, max_steps=30)
result = await agent.run(message)
```

**Zd≈Øvodnƒõn√≠**:
- **Bezstavov√Ω agent**: Ka≈æd√© spu≈°tƒõn√≠ agenta je nez√°visl√©, zabra≈àuje √∫niku stavu
- **Bezpeƒçnost vl√°ken**: ≈Ω√°dn√Ω sd√≠len√Ω mƒõniteln√Ω stav mezi soubƒõ≈æn√Ωmi po≈æadavky
- **ƒåist√© proveden√≠**: ƒåerstv√Ω stav agenta zaji≈°≈•uje p≈ôedv√≠dateln√© chov√°n√≠
- **Pamƒõ≈• v session**: Kontext konverzace je zachov√°n v objektu session, ne v agentovi

Pamƒõ≈• session je pot√© aktualizov√°na po ka≈æd√©m √∫spƒõ≈°n√©m spu≈°tƒõn√≠ pro zachov√°n√≠ kontinuity.

## üîß Technologick√Ω stack

### Hlavn√≠ knihovny

| Knihovna | Verze | √öƒçel | Proƒç tato volba? |
|---------|---------|---------|------------------|
| **FastAPI** | Latest | Web framework | Modern√≠ asynchronn√≠ podpora, automatick√© OpenAPI dokumenty, typov√° bezpeƒçnost |
| **LangChain** | 0.3.27 | LLM orchestrace | Pr≈Ømyslov√Ω standard pro agentn√≠ workflow, rozs√°hl√© integrace |
| **LangChain-OpenAI** | 0.3.34 | OpenAI LLM wrapper | Jednotn√© rozhran√≠ pro OpenAI-kompatibiln√≠ API |
| **MCP** | 1.16.0 | Model Context Protocol | Standardizovan√Ω protokol pro integraci n√°stroj≈Ø |
| **mcp-use** | 1.3.11 | MCP agent implementace | Vysoko√∫rov≈àov√° abstrakce agenta nad MCP |
| **Uvicorn** | 0.37.0 | ASGI server | Produkƒçnƒõ p≈ôipraven√Ω asynchronn√≠ server pro FastAPI |
| **python-dotenv** | 1.1.1 | Konfigurace prost≈ôed√≠ | Bezpeƒçn√° spr√°va API kl√≠ƒç≈Ø |

### LLM poskytovatel: OpenRouter

Syst√©m pou≈æ√≠v√° [**OpenRouter**](https://openrouter.ai) jako poskytovatele LLM:

```python
llm = ChatOpenAI(
    model="google/gemini-2.5-flash-lite-preview-09-2025",
    openai_api_base="https://openrouter.ai/api/v1",
    openai_api_key=OPENROUTER_API_KEY,
    temperature=0,
)
```

**Proƒç OpenRouter?**
- **Jednotn√© API**: P≈ô√≠stup k v√≠ce poskytovatel≈Øm LLM (OpenAI, Anthropic, Google, atd.) p≈ôes jedno rozhran√≠
- **Flexibilita model≈Ø**: Snadn√© p≈ôep√≠n√°n√≠ mezi modely bez zmƒõn k√≥du
- **Optimalizace n√°klad≈Ø**: V√Ωbƒõr n√°kladovƒõ efektivn√≠ch model≈Ø podle po≈æadavk≈Ø √∫lohy
- **Mo≈ænosti fallbacku**: Lze implementovat automatick√Ω fallback na alternativn√≠ modely
- **Kompatibiln√≠ s OpenAI**: Funguje s wrapperem `ChatOpenAI` z LangChain

**Aktu√°ln√≠ model**: `google/gemini-2.5-flash-lite-preview-09-2025`
- Rychl√© doby odezvy
- N√°kladovƒõ efektivn√≠ pro konverzaƒçn√≠ √∫lohy
- Dobr√° rovnov√°ha mezi schopnostmi a rychlost√≠

### MCP (Model Context Protocol)

**Co je MCP?**
MCP je protokol, kter√Ω umo≈æ≈àuje LLM interagovat s extern√≠mi n√°stroji a datov√Ωmi zdroji standardizovan√Ωm zp≈Øsobem.

**Aktu√°ln√≠ konfigurace**:
```python
config = {
    "mcpServers": {
        "Notion": {
            "url": "https://mcp.notion.com/mcp"
        }
    }
}
```

**Proƒç MCP?**
- **Standardizovan√© vol√°n√≠ n√°stroj≈Ø**: Konzistentn√≠ rozhran√≠ pro r≈Øzn√© n√°stroje
- **Automatick√© zji≈°≈•ov√°n√≠**: N√°stroje vystavuj√≠ sv√© schopnosti pomoc√≠ protokolu
- **Typov√° bezpeƒçnost**: Strukturovan√° validace vstupu/v√Ωstupu
- **Roz≈°i≈ôiteln√©**: Snadn√© p≈ôid√°v√°n√≠ nov√Ωch integrac√≠ n√°stroj≈Ø

## üì° API Endpointy

### 1. REST API - `/api/chat` (POST)

**Nejlep≈°√≠ pro**: Jednoduch√© interakce po≈æadavek/odpovƒõƒè, nen√≠ pot≈ôeba streaming

**Po≈æadavek**:
```json
{
  "message": "Create a new Notion page called 'Meeting Notes'",
  "session_id": "user-123"
}
```

**Odpovƒõƒè**:
```json
{
  "response": "I've created a new page titled 'Meeting Notes' in your Notion workspace.",
  "session_id": "user-123"
}
```

**Implementace**: [`src/api.py:29-32`](../src/api.py:29-32)

**P≈ô√≠klad**:
```bash
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "What tasks do I have?", "session_id": "user-123"}'
```

### 2. WebSocket - `/ws/chat`

**Nejlep≈°√≠ pro**: Real-time obousmƒõrn√° komunikace, interaktivn√≠ chatov√© aplikace

**P≈ôipojen√≠ klienta**:
```javascript
const ws = new WebSocket('ws://localhost:8000/ws/chat');

ws.onopen = () => {
  ws.send(JSON.stringify({
    message: "List my Notion pages",
    session_id: "user-123"
  }));
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log(data);
};
```

**Typy zpr√°v**:
- `status`: Notifikace o zpracov√°n√≠
- `response`: Odpovƒõƒè agenta (s `done: true`)
- `error`: Chybov√° zpr√°va

**Implementace**: [`src/api.py:35-73`](../src/api.py:35-73)

**Proƒç WebSocket?**
- Perzistentn√≠ p≈ôipojen√≠ sni≈æuje latenci
- Umo≈æ≈àuje indik√°tory psan√≠ a aktualizace pr≈Øbƒõhu
- Skuteƒçnƒõ obousmƒõrn√° komunikace
- Lep≈°√≠ pro chatov√° rozhran√≠

### 3. Server-Sent Events - `/api/chat/stream` (GET)

**Nejlep≈°√≠ pro**: Jednosmƒõrn√Ω streaming ze serveru na klienta

**Po≈æadavek**:
```bash
curl -N http://localhost:8000/api/chat/stream?message=Hello
```

**Stream odpovƒõdi**:
```
data: {"type": "status", "message": "Processing..."}

data: {"type": "response", "message": "Hi! How can I help?", "done": true}
```

**Implementace**: [`src/api.py:76-102`](../src/api.py:76-102)

**JavaScript p≈ô√≠klad**:
```javascript
const eventSource = new EventSource(
  'http://localhost:8000/api/chat/stream?message=Hello'
);

eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log(data);
};
```

**Proƒç SSE?**
- Jednodu≈°≈°√≠ ne≈æ WebSocket pro jednosmƒõrn√Ω streaming
- Funguje p≈ôes standardn√≠ HTTP
- Automatick√° podpora opƒõtovn√©ho p≈ôipojen√≠
- Lep≈°√≠ kompatibilita s firewallem

### 4. Pomocn√© endpointy

**Health Check** - `GET /health`
```json
{"status": "healthy"}
```

**Root** - `GET /`
```json
{"message": "MCP Agent API is running"}
```

## üöÄ Spu≈°tƒõn√≠ API

### P≈ôedpoklady

1. **Python 3.8+**
2. **Promƒõnn√© prost≈ôed√≠**:
   ```bash
   # .env soubor
   OPENROUTER_API_KEY=your_api_key_here
   ```

### Instalace

```bash
# Instalace z√°vislost√≠
pip install -r requirements.txt
```

### Spu≈°tƒõn√≠ serveru

**Z√°kladn√≠ spu≈°tƒõn√≠**:
```bash
python main.py
```

**S mo≈ænostmi**:
```bash
# Vlastn√≠ port
python main.py --port 8080

# Zapnut√≠ auto-reload pro v√Ωvoj
python main.py --reload

# Debug logov√°n√≠
python main.py --log-level debug

# Vlastn√≠ host (produkce)
python main.py --host 0.0.0.0 --port 8000
```

**Promƒõnn√© prost≈ôed√≠**:
```bash
export API_HOST=0.0.0.0
export API_PORT=8080
export RELOAD=true
export LOG_LEVEL=debug
python main.py
```

### Produkƒçn√≠ nasazen√≠

**Pou≈æit√≠ Gunicorn**:
```bash
pip install gunicorn
gunicorn -w 4 -k uvicorn.workers.UvicornWorker src.api:app --bind 0.0.0.0:8000
```

**Docker**:
```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
CMD ["python", "main.py"]
```

## üß™ Testov√°n√≠

### Manu√°ln√≠ testov√°n√≠

**REST API**:
```bash
curl -X POST http://localhost:8000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "Hello", "session_id": "test-1"}'
```

**WebSocket** (pou≈æit√≠ `websocat`):
```bash
websocat ws://localhost:8000/ws/chat
# Pot√© odeslat: {"message": "Hello", "session_id": "test-1"}
```

### Automatizovan√© testov√°n√≠

Spu≈°tƒõn√≠ testovac√≠ho skriptu konverzace:
```bash
python test/api_conversation_test.py
```

Tento skript ([`test/api_conversation_test.py`](../test/api_conversation_test.py)) demonstruje:
- V√≠cetahov√© konverzace
- Spr√°vu session
- Zachov√°n√≠ kontextu nap≈ô√≠ƒç po≈æadavky

### API dokumentace

FastAPI automaticky generuje interaktivn√≠ API dokumentaci:
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## üîí Bezpeƒçnostn√≠ aspekty

### Aktu√°ln√≠ implementace
- CORS povolen pro localhost:3000 a localhost:3001
- Nen√≠ implementov√°na autentizace

### Doporuƒçen√≠ pro produkci

1. **Autentizace pomoc√≠ API kl√≠ƒçe**:
```python
from fastapi import Security, HTTPException
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials

security = HTTPBearer()

async def verify_token(credentials: HTTPAuthorizationCredentials = Security(security)):
    if credentials.credentials != "your-secret-key":
        raise HTTPException(status_code=401, detail="Invalid token")
    return credentials.credentials
```

2. **Rate Limiting**:
```bash
pip install slowapi
```

3. **Pouze HTTPS** v produkci
4. **CORS podle prost≈ôed√≠**:
```python
allow_origins = os.getenv("CORS_ORIGINS", "").split(",")
```

## üéØ Souhrn n√°vrhov√Ωch rozhodnut√≠

| Rozhodnut√≠ | Zd≈Øvodnƒõn√≠ |
|----------|-----------|
| **Architektura zalo≈æen√° na sessions** | Udr≈æuje kontext konverzace pro ka≈æd√©ho u≈æivatele |
| **ConversationBufferMemory** | Jednoduch√°, kompletn√≠ historie pro lep≈°√≠ kontext |
| **Nov√Ω agent pro ka≈æd√Ω po≈æadavek** | Bezpeƒçn√© pro vl√°kna, bezstavov√© prov√°dƒõn√≠ |
| **OpenRouter** | Flexibiln√≠ poskytovatel LLM s v√≠ce mo≈ænostmi model≈Ø |
| **V√≠ce typ≈Ø endpoint≈Ø** | Podpora r≈Øzn√Ωch klientsk√Ωch architektur (REST/WS/SSE) |
| **Sessions v pamƒõti** | Jednoduch√© pro v√Ωvoj; nahradit Redis pro produkci |
| **FastAPI** | Modern√≠ asynchronn√≠ framework s vynikaj√≠c√≠ v√Ωvoj√°≈ôskou zku≈°enost√≠ |
| **MCP protokol** | Standardizovan√° integrace n√°stroj≈Ø |

## üìö Struktura k√≥du

```
.
‚îú‚îÄ‚îÄ main.py                      # Vstupn√≠ bod s CLI mo≈ænostmi
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ api.py                   # FastAPI endpointy
‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îÇ       ‚îî‚îÄ‚îÄ agent_core.py        # Logika agenta a spr√°va session
‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îî‚îÄ‚îÄ api_conversation_test.py # Skript pro testov√°n√≠ konverzace
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ README_API.md           # Tento soubor
‚îî‚îÄ‚îÄ requirements.txt            # Python z√°vislosti
```

## üîÑ Roz≈°i≈ôov√°n√≠ syst√©mu

### P≈ôid√°n√≠ nov√Ωch MCP n√°stroj≈Ø

Upravit [`agent_core.py`](../src/lib/agent_core.py:39-45):
```python
config = {
    "mcpServers": {
        "Notion": {"url": "https://mcp.notion.com/mcp"},
        "GitHub": {"url": "https://github-mcp.example.com/mcp"}
    }
}
```

### Zmƒõna LLM modelu

Upravit [`agent_core.py`](../src/lib/agent_core.py:31-36):
```python
self.llm = ChatOpenAI(
    model="anthropic/claude-3.5-sonnet",  # Zmƒõnit model
    openai_api_base="https://openrouter.ai/api/v1",
    openai_api_key=OPENROUTER_API_KEY,
    temperature=0.7,  # Upravit kreativitu
)
```

### Implementace perzistentn√≠ch sessions

Nahradit √∫lo≈æi≈°tƒõ v pamƒõti Redis:
```python
import redis
import json

redis_client = redis.Redis(host='localhost', port=6379, db=0)

def get_session(session_id: str):
    data = redis_client.get(f"session:{session_id}")
    return json.loads(data) if data else None

def save_session(session_id: str, session_data: dict):
    redis_client.set(f"session:{session_id}", json.dumps(session_data))
```

## üìä Aspekty v√Ωkonu

- **Max Steps**: Agent m√° `max_steps=30` pro prevenci nekoneƒçn√Ωch smyƒçek
- **Temperature**: Nastavena na `0` pro deterministick√© odpovƒõdi
- **Soubƒõ≈æn√© po≈æadavky**: FastAPI efektivnƒõ zpracov√°v√° soubƒõ≈æn√© po≈æadavky
- **R≈Øst pamƒõti**: Sledovat √∫lo≈æi≈°tƒõ sessions, implementovat ƒçi≈°tƒõn√≠ star√Ωch sessions

## üêõ ≈òe≈°en√≠ probl√©m≈Ø

**Agent neodpov√≠d√°**:
- Zkontrolujte `OPENROUTER_API_KEY` v `.env`
- Ovƒõ≈ôte, ≈æe URL MCP server≈Ø jsou p≈ô√≠stupn√©
- Zkontrolujte logy pro podrobn√© chybov√© zpr√°vy

**Session se neuchov√°v√°**:
- Sessions jsou v pamƒõti; restart je vyma≈æe
- Implementujte Redis pro perzistenci

**CORS chyby**:
- P≈ôidejte URL va≈°eho frontendu do `allow_origins` v [`api.py`](../src/api.py:18)

## üìù Dal≈°√≠ zdroje

- [FastAPI dokumentace](https://fastapi.tiangolo.com/)
- [LangChain dokumentace](https://python.langchain.com/)
- [Model Context Protocol](https://modelcontextprotocol.io/)
- [OpenRouter dokumentace](https://openrouter.ai/docs)
